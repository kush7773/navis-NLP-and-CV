<!DOCTYPE html>
<html lang="en">

<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
        <title>ü§ñ Navis Voice + Follow Control</title>
        <style>
                * {
                        margin: 0;
                        padding: 0;
                        box-sizing: border-box;
                }

                body {
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        min-height: 100vh;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        padding: 20px;
                        overflow-x: hidden;
                }

                .container {
                        width: 100%;
                        max-width: 500px;
                        background: rgba(0, 0, 0, 0.3);
                        backdrop-filter: blur(10px);
                        padding: 30px;
                        border-radius: 25px;
                        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
                }

                h1 {
                        text-align: center;
                        margin-bottom: 10px;
                        font-size: 28px;
                        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
                }

                .subtitle {
                        text-align: center;
                        opacity: 0.8;
                        margin-bottom: 20px;
                        font-size: 14px;
                }

                /* Follow Mode Indicator */
                .follow-indicator {
                        background: rgba(255, 255, 255, 0.1);
                        padding: 15px;
                        border-radius: 15px;
                        margin-bottom: 20px;
                        text-align: center;
                        border: 2px solid transparent;
                        transition: all 0.3s ease;
                }

                .follow-indicator.active {
                        border-color: #4ade80;
                        background: rgba(74, 222, 128, 0.2);
                        animation: glow 2s infinite;
                }

                @keyframes glow {

                        0%,
                        100% {
                                box-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
                        }

                        50% {
                                box-shadow: 0 0 20px rgba(74, 222, 128, 0.8);
                        }
                }

                .follow-status {
                        font-size: 18px;
                        font-weight: bold;
                }

                .follow-status.active {
                        color: #4ade80;
                }

                .follow-status.inactive {
                        color: #ff6b6b;
                }

                /* Voice Control Section */
                .voice-section {
                        text-align: center;
                        margin-bottom: 30px;
                }

                #recordBtn {
                        width: 180px;
                        height: 180px;
                        border-radius: 50%;
                        border: none;
                        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                        color: white;
                        font-size: 20px;
                        font-weight: bold;
                        cursor: pointer;
                        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
                        transition: all 0.3s ease;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        margin: 0 auto;
                        user-select: none;
                        -webkit-tap-highlight-color: transparent;
                }

                #recordBtn:active {
                        transform: scale(0.95);
                        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
                        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
                }

                #recordBtn.recording {
                        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
                        animation: pulse 1.5s infinite;
                }

                @keyframes pulse {

                        0%,
                        100% {
                                transform: scale(1);
                        }

                        50% {
                                transform: scale(1.05);
                        }
                }

                .mic-icon {
                        font-size: 48px;
                        margin-bottom: 10px;
                }

                /* Quick Commands */
                .quick-commands {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 10px;
                        margin-top: 20px;
                }

                .quick-cmd-btn {
                        padding: 12px;
                        border: 2px solid rgba(255, 255, 255, 0.3);
                        background: rgba(255, 255, 255, 0.1);
                        color: white;
                        border-radius: 15px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: bold;
                        transition: all 0.3s ease;
                }

                .quick-cmd-btn:active {
                        transform: scale(0.95);
                        background: rgba(255, 255, 255, 0.2);
                }

                .quick-cmd-btn.follow {
                        border-color: #4ade80;
                }

                .quick-cmd-btn.stop {
                        border-color: #ff6b6b;
                }

                /* Status Display */
                #status {
                        margin-top: 25px;
                        padding: 20px;
                        background: rgba(255, 255, 255, 0.1);
                        border-radius: 15px;
                        min-height: 120px;
                        font-size: 14px;
                        line-height: 1.6;
                        text-align: left;
                }

                #status p {
                        margin: 8px 0;
                }

                #status strong {
                        color: #ffd700;
                }

                /* Text Input Section */
                .text-section {
                        margin-top: 30px;
                        padding-top: 25px;
                        border-top: 1px solid rgba(255, 255, 255, 0.2);
                }

                .text-section h3 {
                        text-align: center;
                        margin-bottom: 15px;
                        font-size: 16px;
                        opacity: 0.9;
                }

                .input-group {
                        display: flex;
                        gap: 10px;
                }

                input[type="text"] {
                        flex: 1;
                        padding: 15px;
                        border: none;
                        border-radius: 25px;
                        font-size: 15px;
                        background: rgba(255, 255, 255, 0.9);
                        color: #333;
                }

                input[type="text"]:focus {
                        outline: none;
                        box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
                }

                button.send {
                        padding: 15px 25px;
                        border: none;
                        border-radius: 25px;
                        background: #00d4ff;
                        color: white;
                        font-weight: bold;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        font-size: 15px;
                }

                button.send:active {
                        transform: scale(0.95);
                        background: #00a8cc;
                }

                /* Loading Spinner */
                .spinner {
                        display: inline-block;
                        width: 20px;
                        height: 20px;
                        border: 3px solid rgba(255, 255, 255, 0.3);
                        border-top-color: white;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                }

                @keyframes spin {
                        to {
                                transform: rotate(360deg);
                        }
                }

                .error {
                        color: #ff6b6b;
                        background: rgba(255, 107, 107, 0.2);
                        padding: 10px;
                        border-radius: 10px;
                        margin-top: 10px;
                }

                .success {
                        color: #4ade80;
                }

                /* Video & Joystick Panel */
                .video-container {
                        width: 100%;
                        border-radius: 15px;
                        overflow: hidden;
                        margin-bottom: 20px;
                        border: 2px solid rgba(255, 255, 255, 0.2);
                        position: relative;
                        background: #000;
                }

                .video-feed {
                        width: 100%;
                        display: block;
                }

                .joystick-panel {
                        display: grid;
                        grid-template-columns: repeat(3, 1fr);
                        gap: 10px;
                        max-width: 200px;
                        margin: 20px auto;
                }

                .joy-btn {
                        background: rgba(255, 255, 255, 0.1);
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        border-radius: 10px;
                        aspect-ratio: 1;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 24px;
                        cursor: pointer;
                        user-select: none;
                        transition: all 0.1s;
                }

                .joy-btn:active {
                        background: rgba(0, 212, 255, 0.3);
                        transform: scale(0.95);
                }

                .joy-center {
                        background: rgba(255, 107, 107, 0.2);
                        border-color: rgba(255, 107, 107, 0.5);
                }

                .joy-center:active {
                        background: rgba(255, 107, 107, 0.4);
                }
        </style>
</head>

<body>
        <div class="container">
                <h1>ü§ñ Navis Control</h1>
                <p class="subtitle">Voice + Follow Mode</p>

                <!-- Video Feed -->
                <div class="video-container">
                        <img src="/video_feed" class="video-feed" alt="Live Camera Feed">
                        <div style="position: absolute; top: 10px; right: 10px;">
                                <button onclick="toggleFaceDetection()"
                                        style="background: rgba(0,0,0,0.5); border: 1px solid white; color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px;">
                                        üëÅÔ∏è Face AI
                                </button>
                        </div>
                </div>

                <!-- Joystick Controls -->
                <div class="joystick-panel">
                        <div></div>
                        <button class="joy-btn" onmousedown="startDrive('F')" ontouchstart="startDrive('F')"
                                onmouseup="stopDrive()" ontouchend="stopDrive()">‚¨ÜÔ∏è</button>
                        <div></div>
                        <button class="joy-btn" onmousedown="startDrive('L')" ontouchstart="startDrive('L')"
                                onmouseup="stopDrive()" ontouchend="stopDrive()">‚¨ÖÔ∏è</button>
                        <button class="joy-btn joy-center" onclick="stopDrive()">üõë</button>
                        <button class="joy-btn" onmousedown="startDrive('R')" ontouchstart="startDrive('R')"
                                onmouseup="stopDrive()" ontouchend="stopDrive()">‚û°Ô∏è</button>
                        <div></div>
                        <button class="joy-btn" onmousedown="startDrive('B')" ontouchstart="startDrive('B')"
                                onmouseup="stopDrive()" ontouchend="stopDrive()">‚¨áÔ∏è</button>
                        <div></div>
                </div>

                <!-- Follow Mode Indicator -->
                <div class="follow-indicator" id="followIndicator">
                        <div class="follow-status inactive" id="followStatus">
                                ‚è∏Ô∏è Follow Mode: Inactive
                        </div>
                        <p style="opacity: 0.7; margin-top: 5px; font-size: 12px;">Say "Follow me Navis" to activate</p>
                </div>

                <!-- Voice Control -->
                <div class="voice-section">
                        <button id="recordBtn">
                                <div class="mic-icon">üé§</div>
                                <div id="btnText">Hold to Speak</div>
                        </button>

                        <!-- Quick Command Buttons -->
                        <div class="quick-commands">
                                <button class="quick-cmd-btn follow" onclick="quickCommand('follow me navis')">
                                        üéØ Follow Me
                                </button>
                                <button class="quick-cmd-btn stop" onclick="quickCommand('stop navis')">
                                        ‚èπÔ∏è Stop
                                </button>
                        </div>

                        <div id="status">
                                <strong>Ready to listen...</strong>
                                <p style="opacity: 0.7; margin-top: 10px;">
                                        üé§ Hold button to speak<br>
                                        üéØ Say "Follow me Navis" to activate tracking<br>
                                        ‚èπÔ∏è Say "Stop Navis" to stop
                                </p>
                        </div>
                </div>

                <!-- Text Input Alternative -->
                <div class="text-section">
                        <h3>üí¨ Or Type Your Message</h3>
                        <div class="input-group">
                                <input type="text" id="textInput" placeholder="Type command or question...">
                                <button class="send" onclick="sendText()">Send</button>
                        </div>
                </div>

                <!-- Person Training -->
                <div class="text-section">
                        <h3
                                onclick="document.getElementById('trainingPanel').style.display=document.getElementById('trainingPanel').style.display==='none'?'block':'none'">
                                üë§ Person Training (Tap)
                        </h3>
                        <div id="trainingPanel"
                                style="display:none;padding:15px;background:rgba(255,255,255,0.05);border-radius:15px;">
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px;">
                                        <button onclick="capturePerson('front')"
                                                style="padding:10px;border:1px solid #4ade80;background:rgba(74,222,128,0.1);color:#4ade80;border-radius:10px;">
                                                üì∏ Capture Front
                                        </button>
                                        <button onclick="capturePerson('back')"
                                                style="padding:10px;border:1px solid #4ade80;background:rgba(74,222,128,0.1);color:#4ade80;border-radius:10px;">
                                                üì∏ Capture Back
                                        </button>
                                </div>

                                <div style="margin-bottom:15px;">
                                        <input type="text" id="personName" placeholder="Enter Name"
                                                style="width:100%;margin-bottom:10px;padding:10px;border-radius:10px;border:none;">
                                        <input type="file" id="uploadPhoto" accept="image/*" style="display:none"
                                                onchange="uploadPhoto(this)">
                                        <button onclick="document.getElementById('uploadPhoto').click()"
                                                style="width:100%;padding:10px;background:#00d4ff;border:none;border-radius:10px;color:white;font-weight:bold;">
                                                üì§ Upload Photo
                                        </button>
                                </div>

                                <button onclick="clearPerson()"
                                        style="width:100%;padding:10px;background:#ff6b6b;border:none;border-radius:10px;color:white;">
                                        üóëÔ∏è Clear Training Data
                                </button>

                                <div id="trainingStatus"
                                        style="margin-top:10px;font-size:12px;opacity:0.8;text-align:center;"></div>
                        </div>
                </div>

                <!-- Hand & Arm Controls -->
                <div class="text-section">
                        <h3
                                onclick="document.getElementById('handPanel').style.display=document.getElementById('handPanel').style.display==='none'?'block':'none'">
                                üñêÔ∏è Hand & Arm Controls (Tap)</h3>
                        <div id="handPanel"
                                style="display:none;padding:15px;background:rgba(255,255,255,0.05);border-radius:15px;">
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px;">
                                        <button onclick="fetch('/hand_control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({command:'LC'})}).then(r=>r.json()).then(d=>alert(d.message||d.error))"
                                                style="padding:12px;border:2px solid #00d4ff;background:rgba(255,255,255,0.05);border-radius:12px;color:#00d4ff;font-weight:bold;">üëê
                                                Left Open</button>
                                        <button onclick="fetch('/hand_control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({command:'RC'})}).then(r=>r.json()).then(d=>alert(d.message||d.error))"
                                                style="padding:12px;border:2px solid #00ff88;background:rgba(255,255,255,0.05);border-radius:12px;color:#00ff88;font-weight:bold;">üëê
                                                Right Open</button>
                                        <button onclick="fetch('/hand_control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({command:'LO'})}).then(r=>r.json()).then(d=>alert(d.message||d.error))"
                                                style="padding:12px;border:2px solid #00d4ff;background:rgba(255,255,255,0.05);border-radius:12px;color:#00d4ff;font-weight:bold;">‚úä
                                                Left Close</button>
                                        <button onclick="fetch('/hand_control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({command:'RO'})}).then(r=>r.json()).then(d=>alert(d.message||d.error))"
                                                style="padding:12px;border:2px solid #00ff88;background:rgba(255,255,255,0.05);border-radius:12px;color:#00ff88;font-weight:bold;">‚úä
                                                Right Close</button>
                                </div>
                                <div style="margin:15px 0;">
                                        <div
                                                style="display:flex;justify-content:space-between;margin-bottom:8px;font-size:12px;">
                                                <span>Left Wrist</span><span id="lw">90¬∞</span>
                                        </div>
                                        <input type="range" min="0" max="180" value="90"
                                                oninput="document.getElementById('lw').textContent=this.value+'¬∞';fetch('/wrist_control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({side:'L',angle:this.value})})"
                                                style="width:100%;height:6px;border-radius:5px;background:rgba(255,255,255,0.2);">
                                </div>
                                <div style="margin:15px 0;">
                                        <div
                                                style="display:flex;justify-content:space-between;margin-bottom:8px;font-size:12px;">
                                                <span>Right Wrist</span><span id="rw">90¬∞</span>
                                        </div>
                                        <input type="range" min="0" max="180" value="90"
                                                oninput="document.getElementById('rw').textContent=this.value+'¬∞';fetch('/wrist_control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({side:'R',angle:this.value})})"
                                                style="width:100%;height:6px;border-radius:5px;background:rgba(255,255,255,0.2);">
                                </div>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:15px;">
                                        <button onclick="fetch('/bicep_control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({command:'BLU'})}).then(r=>r.json()).then(d=>alert(d.message||d.error))"
                                                style="padding:10px;border:2px solid #00d4ff;background:rgba(255,255,255,0.05);border-radius:10px;color:#00d4ff;font-weight:bold;">‚¨ÜÔ∏è
                                                L Up</button>
                                        <button onclick="fetch('/bicep_control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({command:'BRU'})}).then(r=>r.json()).then(d=>alert(d.message||d.error))"
                                                style="padding:10px;border:2px solid #00ff88;background:rgba(255,255,255,0.05);border-radius:10px;color:#00ff88;font-weight:bold;">‚¨ÜÔ∏è
                                                R Up</button>
                                        <button onclick="fetch('/bicep_control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({command:'BLD'})}).then(r=>r.json()).then(d=>alert(d.message||d.error))"
                                                style="padding:10px;border:2px solid #00d4ff;background:rgba(255,255,255,0.05);border-radius:10px;color:#00d4ff;font-weight:bold;">‚¨áÔ∏è
                                                L Down</button>
                                        <button onclick="fetch('/bicep_control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({command:'BRD'})}).then(r=>r.json()).then(d=>alert(d.message||d.error))"
                                                style="padding:10px;border:2px solid #00ff88;background:rgba(255,255,255,0.05);border-radius:10px;color:#00ff88;font-weight:bold;">‚¨áÔ∏è
                                                R Down</button>
                                </div>
                                <button onclick="fetch('/bicep_control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({command:'BS'})}).then(r=>r.json()).then(d=>alert(d.message||d.error))"
                                        style="width:100%;padding:15px;background:linear-gradient(135deg,#ff6b6b,#ee5a6f);border:none;border-radius:12px;color:white;font-weight:bold;margin-top:10px;">ÔøΩÔøΩ
                                        STOP BICEPS</button>
                        </div>
                </div>
        </div>

        <script>
                let mediaRecorder;
                let audioChunks = [];
                const recordBtn = document.getElementById('recordBtn');
                const btnText = document.getElementById('btnText');
                const statusDiv = document.getElementById('status');
                const followIndicator = document.getElementById('followIndicator');
                const followStatus = document.getElementById('followStatus');

                // Update follow status indicator
                function updateFollowStatus(isActive) {
                        if (isActive) {
                                followIndicator.classList.add('active');
                                followStatus.classList.remove('inactive');
                                followStatus.classList.add('active');
                                followStatus.innerHTML = '‚úÖ Follow Mode: ACTIVE';
                        } else {
                                followIndicator.classList.remove('active');
                                followStatus.classList.remove('active');
                                followStatus.classList.add('inactive');
                                followStatus.innerHTML = '‚è∏Ô∏è Follow Mode: Inactive';
                        }
                }

                // Check follow status periodically
                setInterval(async () => {
                        try {
                                const response = await fetch('/follow_status');
                                const data = await response.json();
                                updateFollowStatus(data.follow_active);
                        } catch (error) {
                                console.error('Status check error:', error);
                        }
                }, 2000);

                // Initialize microphone
                async function initMicrophone() {
                        try {
                                const stream = await navigator.mediaDevices.getUserMedia({
                                        audio: {
                                                echoCancellation: true,
                                                noiseSuppression: true,
                                                autoGainControl: true
                                        }
                                });

                                mediaRecorder = new MediaRecorder(stream, {
                                        mimeType: 'audio/webm'
                                });

                                mediaRecorder.ondataavailable = (event) => {
                                        if (event.data.size > 0) {
                                                audioChunks.push(event.data);
                                        }
                                };

                                mediaRecorder.onstop = async () => {
                                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                                        audioChunks = [];
                                        await sendAudio(audioBlob);
                                };

                        } catch (error) {
                                console.error('Microphone error:', error);
                                statusDiv.innerHTML = '<div class="error">‚ùå Microphone access denied. Please allow microphone access.</div>';
                                recordBtn.disabled = true;
                        }
                }

                // Send audio to server
                async function sendAudio(audioBlob) {
                        const formData = new FormData();
                        formData.append('audio', audioBlob, 'recording.webm');

                        statusDiv.innerHTML = '<div class="spinner"></div> <strong>Processing...</strong>';

                        try {
                                const response = await fetch('/audio_upload', {
                                        method: 'POST',
                                        body: formData
                                });

                                const result = await response.json();

                                if (result.error) {
                                        statusDiv.innerHTML = `<div class="error">‚ùå ${result.error}</div>`;
                                } else {
                                        statusDiv.innerHTML = `
                        <p><strong>üë§ You:</strong> ${result.transcription}</p>
                        <p><strong>ü§ñ Navis:</strong> ${result.response}</p>
                        <p style="opacity: 0.6; margin-top: 10px; font-size: 12px;">üîä Speaking...</p>
                    `;

                                        // Update follow status if command was executed
                                        if (result.follow_active !== undefined) {
                                                updateFollowStatus(result.follow_active);
                                        }
                                }
                        } catch (error) {
                                statusDiv.innerHTML = `<div class="error">‚ùå Network error</div>`;
                        }
                }

                // Recording controls
                function startRecording(e) {
                        e.preventDefault();
                        if (mediaRecorder && mediaRecorder.state === 'inactive') {
                                audioChunks = [];
                                mediaRecorder.start();
                                recordBtn.classList.add('recording');
                                btnText.textContent = 'Recording...';
                                statusDiv.innerHTML = '<strong>üé§ Listening...</strong>';
                        }
                }

                function stopRecording(e) {
                        e.preventDefault();
                        if (mediaRecorder && mediaRecorder.state === 'recording') {
                                mediaRecorder.stop();
                                recordBtn.classList.remove('recording');
                                btnText.textContent = 'Hold to Speak';
                        }
                }

                recordBtn.addEventListener('mousedown', startRecording);
                recordBtn.addEventListener('touchstart', startRecording);
                recordBtn.addEventListener('mouseup', stopRecording);
                recordBtn.addEventListener('touchend', stopRecording);
                recordBtn.addEventListener('mouseleave', stopRecording);

                // Quick command buttons
                async function quickCommand(command) {
                        statusDiv.innerHTML = '<div class="spinner"></div> <strong>Processing...</strong>';

                        try {
                                const response = await fetch('/text_chat', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ message: command })
                                });

                                const result = await response.json();

                                statusDiv.innerHTML = `
                    <p><strong>ü§ñ Navis:</strong> ${result.response}</p>
                    <p style="opacity: 0.6; margin-top: 10px; font-size: 12px;">üîä Speaking...</p>
                `;

                                if (result.follow_active !== undefined) {
                                        updateFollowStatus(result.follow_active);
                                }
                        } catch (error) {
                                statusDiv.innerHTML = `<div class="error">‚ùå Error</div>`;
                        }
                }

                // Text input
                async function sendText() {
                        const input = document.getElementById('textInput');
                        const text = input.value.trim();

                        if (!text) return;

                        statusDiv.innerHTML = '<div class="spinner"></div> <strong>Processing...</strong>';

                        try {
                                const response = await fetch('/text_chat', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ message: text })
                                });

                                const result = await response.json();

                                statusDiv.innerHTML = `
                    <p><strong>üë§ You:</strong> ${text}</p>
                    <p><strong>ü§ñ Navis:</strong> ${result.response}</p>
                    <p style="opacity: 0.6; margin-top: 10px; font-size: 12px;">üîä Speaking...</p>
                `;

                                if (result.follow_active !== undefined) {
                                        updateFollowStatus(result.follow_active);
                                }

                                input.value = '';
                        } catch (error) {
                                statusDiv.innerHTML = `<div class="error">‚ùå Error</div>`;
                        }
                }

                document.getElementById('textInput').addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') sendText();
                });

                // Initialize
                initMicrophone();

                // Joystick Control
                let driveInterval = null;

                function startDrive(command) {
                        if (driveInterval) clearInterval(driveInterval);
                        drive(command); // Send immediate
                        driveInterval = setInterval(() => drive(command), 200); // Repeat every 200ms
                }

                function stopDrive() {
                        if (driveInterval) {
                                clearInterval(driveInterval);
                                driveInterval = null;
                        }
                        drive('S');
                }

                async function drive(command) {
                        try {
                                await fetch('/manual_control', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ command: command })
                                });
                        } catch (e) {
                                console.error("Drive error:", e);
                        }
                }

                // Person Training Functions
                async function capturePerson(view) {
                        const name = document.getElementById('personName').value || "Target Person";
                        try {
                                const res = await fetch('/capture_person', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ name: name, view: view })
                                });
                                const data = await res.json();
                                alert(data.message || data.error);
                                updatePersonStatus();
                        } catch (e) { alert("Error: " + e); }
                }

                async function uploadPhoto(input) {
                        const file = input.files[0];
                        if (!file) return;

                        const reader = new FileReader();
                        reader.onload = async function (e) {
                                const name = document.getElementById('personName').value || "Target Person";
                                try {
                                        const res = await fetch('/upload_person_photo', {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify({
                                                        image: e.target.result,
                                                        name: name,
                                                        view: 'front' // Default to front for uploads
                                                })
                                        });
                                        const data = await res.json();
                                        alert(data.message || data.error);
                                        updatePersonStatus();
                                } catch (err) { alert("Upload error: " + err); }
                        };
                        reader.readAsDataURL(file);
                }

                async function clearPerson() {
                        if (!confirm("Clear all training data?")) return;
                        await fetch('/clear_person', { method: 'POST' });
                        updatePersonStatus();
                }

                async function updatePersonStatus() {
                        try {
                                const res = await fetch('/person_status');
                                const data = await res.json();
                                const statusDiv = document.getElementById('trainingStatus');
                                if (data.enrolled) {
                                        statusDiv.innerHTML = `‚úÖ Trained: ${data.name} (${data.total_views} views)`;
                                } else {
                                        statusDiv.innerHTML = `‚ö†Ô∏è No person enrolled`;
                                }
                        } catch (e) { }
                }

                // Update status on load
                updatePersonStatus();


                // Toggle Face Detection
                async function toggleFaceDetection() {
                        try {
                                const res = await fetch('/toggle_face_detection', { method: 'POST' });
                                const data = await res.json();
                                statusDiv.innerHTML = data.enabled ?
                                        '<span class="success">‚úÖ Face AI Enabled</span>' :
                                        '<span style="color:yellow">‚è∏Ô∏è Face AI Disabled</span>';
                        } catch (e) {
                                console.error("Toggle error:", e);
                        }
                }
        </script>
</body>

</html>